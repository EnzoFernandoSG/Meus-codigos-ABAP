CLASS report_model DEFINITION.
  PUBLIC SECTION.
    TYPES:
      BEGIN OF ty_relatorio,
        lifnr TYPE ekko-lifnr,
        ebeln TYPE ekko-ebeln,
        ebelp TYPE ekpo-ebelp,
      END OF ty_relatorio,

      BEGIN OF ty_estmiro,
        gjahr TYPE rbkp-gjahr,
        belnr TYPE rbkp-belnr,
        xblnr TYPE rbkp-xblnr,
      END OF ty_estmiro,

      BEGIN OF ty_bapi,
        matnr TYPE ekpo-matnr,
        werks TYPE ekpo-werks,
        lgort TYPE ekpo-lgort,
        menge TYPE ekpo-menge,
        meins TYPE ekpo-meins,
        ebeln TYPE ekpo-ebeln,
        ebelp TYPE ekpo-ebelp,
        elikz TYPE ekpo-elikz,
        charg TYPE ekbe-charg,
        lifnr TYPE ekko-lifnr,
        aedat TYPE ekpo-aedat,
        bwart TYPE ekbe-bwart,
        lfbnr TYPE ekbe-lfbnr,
        netwr TYPE ekpo-netwr,
        xblnr TYPE ekbe-xblnr,
        bukrs TYPE ekpo-bukrs,
        zterm TYPE ekko-zterm,
        xunpl TYPE ekbe-xunpl,
        mblnr TYPE mseg-mblnr,
        mjahr TYPE mseg-mjahr,
        zeile TYPE mseg-zeile,
        belnr TYPE ekbe-belnr,
        waers TYPE ekko-waers,
        wrbtr TYPE ekbe-wrbtr,
        bedat TYPE ekko-bedat,
        grost TYPE bapi_rmwwr,
        gjahr TYPE mseg-gjahr,
        cpudt TYPE ekbe-cpudt,
        cputm TYPE ekbe-cputm,
        buzei TYPE ekbe-buzei,
        lfgja TYPE ekbe-lfgja,
      END OF ty_bapi.

    DATA:
      lt_table              TYPE TABLE OF ty_relatorio,
      lt_bapi               TYPE TABLE OF ty_bapi,
      ls_bapi               TYPE ty_bapi,
      lt_estmiro            TYPE TABLE OF ty_estmiro,
      ls_estmiro            TYPE ty_estmiro,
      lt_goodsmvt_item      TYPE TABLE OF bapi2017_gm_item_create,
      ls_goodsmvt_header    TYPE bapi2017_gm_head_01,
      lt_invoice_header     TYPE bapi_incinv_create_header,
      lt_invoice_item       TYPE TABLE OF bapi_incinv_create_item,
      lt_invoice_accounting TYPE TABLE OF bapi_incinv_create_account,
      ls_incv_cancel        TYPE bapi_incinv_fld.

    METHODS:
      select_dados,
      start_of_selection,
      dados_bapi.

ENDCLASS.

CLASS report_model IMPLEMENTATION.

  METHOD:start_of_selection.

    me->select_dados( ).

  ENDMETHOD.

  METHOD select_dados.
    CLEAR lt_table.
    SELECT ekko~lifnr, ekko~ebeln, ekpo~ebelp
      FROM ekpo
      INNER JOIN ekbe
      ON ekpo~ebeln = ekbe~ebeln
      INNER JOIN ekko
      ON ekpo~ebeln = ekko~ebeln
      WHERE ekko~aedat IN @fil_aedt
      AND ekko~lifnr <> ''
*      AND ekbe~bwart <> ''
      AND ekpo~matnr <> ''
      AND ekbe~belnr <> ''
*      AND ekpo~werks <> ''
      AND ekpo~lgort <> ''
      AND ekpo~menge <> ''
*      AND ekbe~charg <> ''
*      AND ekpo~bukrs <> ''
*      AND ekko~waers <> ''
      INTO CORRESPONDING FIELDS OF TABLE @lt_table.

*    SORT lt_table BY ebeln.

  ENDMETHOD.

  METHOD dados_bapi.
    CLEAR lt_bapi.
    "migo
    CLEAR lt_goodsmvt_item.
    CLEAR ls_goodsmvt_header.
    CLEAR lt_goodsmvt_item.
    CLEAR lt_invoice_item.
    DATA: ls_goodsmvt_item TYPE bapi2017_gm_item_create.
    "miro
    DATA:
      lt_invoice_item_line     TYPE bapi_incinv_create_item,
*      lt_invoice_gl_accounting TYPE bapi_incinv_create_gl_account.
      lt_invoice_gl_accounting TYPE bapi_incinv_create_account,
      ls_invoice_head2         TYPE bapi2017_gm_head_02.

    SELECT ekpo~matnr,ekpo~aedat, ekpo~werks, ekpo~lgort, ekpo~menge, ekpo~meins, ekpo~ebeln, ekpo~ebelp, ekpo~elikz,
      ekpo~netwr, ekpo~bukrs, ekbe~belnr, ekbe~cpudt, ekbe~cputm, ekbe~buzei, ekbe~bwart, ekbe~lfbnr , ekbe~charg,
       ekbe~xblnr, ekbe~xunpl, ekbe~wrbtr, ekbe~lfgja, ekko~lifnr, ekko~zterm, ekko~waers, ekko~bedat,mseg~mblnr,mseg~mjahr, mseg~zeile, mseg~gjahr
      FROM ekpo
      INNER JOIN ekbe
      ON ekbe~ebeln = @bapi_compra
      INNER JOIN ekko
      ON ekko~ebeln = @bapi_compra
      INNER JOIN mseg
      ON mseg~ebeln = @bapi_compra
      WHERE ekpo~ebeln = @bapi_compra
        AND ekpo~ebelp = @bapi_item
      INTO CORRESPONDING FIELDS OF TABLE @lt_bapi.

    READ TABLE lt_bapi INTO ls_bapi WITH KEY ebeln = bapi_compra.

    IF command = '1'.

      ls_goodsmvt_item-material    = '001'.        " Código do Material (MATNR)
      ls_goodsmvt_item-plant       = 'PL01'.          " Código da Planta (WERKS)
      ls_goodsmvt_item-stge_loc    = 'SL01'.          " Local de Armazenagem (LGORT)
      ls_goodsmvt_item-move_type   = '101'.           " Tipo de Movimento
      ls_goodsmvt_item-entry_qnt   = '1'.            " Quantidade de Entrada (MENGE)
      ls_goodsmvt_item-entry_uom   = 'EA'.            " Unidade de Medida (MEINS)
      ls_goodsmvt_item-batch       = '0000000187'.       " Lote (se aplicável) (CHARG)
      ls_goodsmvt_item-vendor      = '100000'.        " Código do Fornecedor (LIFNR)
      ls_goodsmvt_item-po_number   = '4500000001'.    " Número do Pedido (EBELN)
      ls_goodsmvt_item-po_item     = '00010'.         " Item do Pedido (EBELP)
*    ls_goodsmvt_item-move_reas   = '001'.           " Motivo da Movimentação (se aplicável)
      ls_goodsmvt_item-orderid     = 'ORD001'.        " Número da Ordem (se aplicável)
      ls_goodsmvt_item-costcenter  = 'CCTR01'.        " Centro de Custo (se aplicável)
      ls_goodsmvt_item-gl_account  = '400000'.        " Conta Contábil (se aplicável)
      ls_goodsmvt_item-orderid     = 'ORD001'.        " Ordem de Produção (se aplicável)
      ls_goodsmvt_item-prod_date   = '20240225'.
      ls_goodsmvt_item-mvt_ind     = 'B'.
      ls_goodsmvt_item-no_more_gr  = 'X'.
      ls_goodsmvt_item-item_text   = 'Teste EG'.

      ls_goodsmvt_header-pstng_date = '20240210'."ls_bapi-aedat.
      ls_goodsmvt_header-doc_date   = sy-datum.

      ls_goodsmvt_item-material     = ls_bapi-matnr.
      ls_goodsmvt_item-move_type    = ls_bapi-bwart.
      ls_goodsmvt_item-plant        = ls_bapi-werks.
      ls_goodsmvt_item-stge_loc     = ls_bapi-lgort.
      ls_goodsmvt_item-batch        = ls_bapi-charg.
      ls_goodsmvt_item-entry_qnt    = ls_bapi-menge.
      ls_goodsmvt_item-po_number    = ls_bapi-ebeln.
      ls_goodsmvt_item-po_item      = ls_bapi-ebelp.
      ls_goodsmvt_item-vendor       = ls_bapi-lifnr.        " Código do Fornecedor (LIFNR)
      ls_goodsmvt_item-entry_uom    = ls_bapi-meins.
*    ls_goodsmvt_item-shipping     = ls_bapi-vstel.
      ls_goodsmvt_item-no_more_gr   = ls_bapi-elikz. " ls_bapi-elikz

      APPEND ls_goodsmvt_item TO lt_goodsmvt_item.

    ENDIF.
    IF command = '2'.
      CLEAR lt_invoice_header.

*      count_doc_item = count_doc_item + 1.

      lt_invoice_header-doc_date = sy-datum.
      lt_invoice_header-invoice_ind = 'X'.

*      ls_bapi-bedat = '20240303'.

      lt_invoice_header-pstng_date   = '20240210'.
      lt_invoice_header-comp_code    = ls_bapi-bukrs.
      lt_invoice_header-currency     = ls_bapi-waers.
      lt_invoice_header-gross_amount = ls_bapi-grost.
      lt_invoice_header-pmnttrms     = ls_bapi-zterm."'0001'."
      lt_invoice_header-ref_doc_no   = ls_bapi-belnr.

* Preenche valores padrão diretamente para os campos do item da MIRO

*      lt_invoice_item_line-item_amount   = 1.   " Valor padrão para o Valor do Item
*      lt_invoice_item_line-quantity      = 1.   " Valor padrão para a Quantidade
*      lt_invoice_item_line-po_unit       = 'PC'. " Unidade de medida padrão
      lt_invoice_item_line-ref_doc   = ls_bapi-mblnr.   " Número do documento de material
      lt_invoice_item_line-ref_doc_year = ls_bapi-mjahr. " Ano do documento de material
      lt_invoice_item_line-ref_doc_it   = ls_bapi-zeile." Item do documento de material
*      lt_invoice_item_line-ref_doc_year  = sy-datum(4). " Ano corrente como padrão
*      lt_invoice_item_line-ref_doc_it    = '0010'. " Número do item padrão

      lt_invoice_item_line-invoice_doc_item   = count_doc_item + 1.
      lt_invoice_item_line-po_number          = ls_bapi-ebeln.
      lt_invoice_item_line-po_item            = ls_bapi-ebelp.
      lt_invoice_item_line-item_amount        = ls_bapi-grost.
      lt_invoice_item_line-quantity           = ls_bapi-menge.
      lt_invoice_item_line-po_unit            = ls_bapi-meins.
      lt_invoice_item_line-tax_code           = 'I1'.

      APPEND lt_invoice_item_line TO lt_invoice_item.

      CLEAR lt_invoice_item_line.
    ENDIF.
    IF command = '4'.
      CLEAR lt_invoice_header.

      SELECT rbkp~belnr, xblnr
        FROM rbkp
        INTO CORRESPONDING FIELDS OF TABLE @lt_estmiro
        where rbkp~xblnr = @ls_bapi-belnr.

      READ TABLE lt_estmiro INTO ls_estmiro WITH KEY xblnr = ls_bapi-belnr.

      ls_incv_cancel-inv_doc_no = ls_estmiro-belnr."belnr "mblnr.  " Número do documento da MIRO
      ls_incv_cancel-fisc_year  = ls_bapi-gjahr.   " Ano fiscal da MIRO
      ls_incv_cancel-reason_rev = '01'.            " Motivo do estorno (padrão)
    ENDIF.
  ENDMETHOD.
ENDCLASS.